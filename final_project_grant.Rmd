---
title: "final_project_grant"
author: "Grant Schumock"
date: "12/2/2019"
  html_document:
    code_folding: "hide"
    toc: TRUE
    toc_float: TRUE
---

Adding and cleaning Census Poverty Data

```{r,message=FALSE}
library(tidyverse)
library(lubridate)
data=read.csv("census_poverty_data.csv",stringsAsFactors = FALSE)
data=filter(data,State!="      United States"&State!="     United States"& State!="District of Columbia"&State!="United States")

names(data)[1:2]<-c("state","poverty")
names(data)[4]<-"year"

skel=expand_grid(sort(unique(data$state)),min(data$year):(max(data$year)+2))
names(skel)<-c("state","year")



sk1=filter(skel,year==2007|year==2008|year==2009)
sk1=left_join(sk1,filter(data,year==2007),by="state")

sk2=filter(skel,year==2010|year==2011|year==2012)
sk2=left_join(sk2,filter(data,year==2010),by="state")

sk3=filter(skel,year==2013|year==2014|year==2015)
sk3=left_join(sk3,filter(data,year==2013),by="state")

sk4=filter(skel,year==2016|year==2017|year==2018)
sk4=left_join(sk4,filter(data,year==2016),by="state")

data=rbind(sk1,sk2,sk3,sk4)
data=data[,1:3]
names(data)<-c("state","year","poverty")



# Mental Health Data
cleaned=1
if(cleaned==0){
data.2016=read.csv("mha2016.csv",stringsAsFactors = FALSE)
data.2017=read.csv("mha2017.csv",stringsAsFactors = FALSE)
data.2018=read.csv("mha2018.csv",stringsAsFactors = FALSE)
data.2019=read.csv("mha2019.csv",stringsAsFactors = FALSE)
data.2020=read.csv("mha2020.csv",stringsAsFactors = FALSE)

names(data.2017)[2]<-"State"

data.2016=data.2016[,c("State","Percent","Year")]
data.2017=data.2017[,c("State","Percent","Year")]
data.2018=data.2018[,c("State","Percent","Year")]
data.2019=data.2019[,c("State","Percent","Year")]
data.2020=data.2020[,c("State","Percent","Year")]
states=sort(unique(data.2020$State))
# Remove DC
states=states[-9]
# Find which states don't match up for each year

states==sort(unique(data.2016$State))
sort(unique(data.2016$State))[8]
# remove DC from 2016 data
data.2016=filter(data.2016,State!="DC")      
states==sort(unique(data.2016$State))
data.2016$State[35]="Louisiana"
states==sort(unique(data.2016$State))
data.2017=filter(data.2017,State!="District of Columbia")
states==sort(unique(data.2017$State))
data.2018=filter(data.2018,State!="District of Columbia")
data.2018$State[9]="Wyoming"
states==sort(unique(data.2018$State))
data.2019=filter(data.2019,State!="District of Columbia"&State!="")
states==sort(unique(data.2019$State))

mh.data=rbind(data.2016,data.2017,data.2018,data.2019,data.2020)
mh.data$Year=mh.data$Year-1      
mh.data$Percent[51]=42.1
mh.data=filter(mh.data,State!="District of Columbia")
write.csv(mh.data,"mh.data.csv")
}
mh.data=read.csv("mh.data.csv",stringsAsFactors = FALSE)

mh.data=mh.data%>%clean_names()
ggplot(data=mh.data,mapping=aes(x=year,y=percent,col=state))+geom_line()
mh.data=filter(mh.data,year!=2015)
z=mh.data%>%group_by(state)%>% summarise(mean.p=mean(percent),
                                       sd.p=sd(percent),
                                       n.p=n())%>%mutate(se.p=sd.p/sqrt(n.p),lower.ci.p=mean.p-qt(1-(0.05/2),n.p-1)*se.p, upper.ci.p=mean.p+qt(1-(0.05/2),n.p-1)*se.p)

ggplot(z,aes(x=state))+geom_point(aes(y=lower.ci.p,color=state))+geom_point(aes(y=upper.ci.p,color=state))

z=gather(z,key="nobodycares",value="ci",lower.ci.p,upper.ci.p)
z%>%ggplot(aes(x=reorder(state,ci,FUN=median)))+geom_boxplot(aes(y=ci,color=state))




#################################################################################################################
# Rand Laws Data
data.rand=read.csv("rand.laws.database.csv",stringsAsFactors = FALSE)

types=c("background check","carrying","castle doctrine","child access","dealer license","age","registration","waiting period","prohibited possessor","safety training","ban","permit","open carry","one gun per")
match.df=as.data.frame(unique(data.rand$Type.of.Law))
match.df <- data.frame(lapply(match.df,as.character),stringsAsFactors=FALSE)
names(match.df)<-"type"
match.df$abv.name=0

i=1
j=1
flag=0
while(i<=nrow(match.df)){
      j=1
      while(j<=length(types)&flag==0){
            if(any(grep(types[j],match.df$type[i],ignore.case=TRUE))){
                  match.df$abv.name[i]=types[j]
                  flag=1
                  }
            else{
                  j=j+1
            }
      }
      flag=0
      i=i+1
}

names(data.rand)[5]="type"
data.rand=left_join(data.rand,match.df,by="type")
names(data.rand)[23]<-"type.of.law"

data.rand=filter(data.rand,Type.of.Change=="Implement"|Type.of.Change=="Modify"|Type.of.Change=="Repeal")
data.rand=filter(data.rand,Effect!="")
data.rand=filter(data.rand,State!="District of Columbia"&State!="DIstrict of Columbia")
data.rand$Supercession.Date[data.rand$Supercession.Date==""]="1/1/2020"
data.rand$end.year=year(mdy(data.rand$Supercession.Date))
data.rand$end.month=month(mdy(data.rand$Supercession.Date))
data.rand$start.year=year(mdy(data.rand$Effective.Date))
data.rand$start.month=month(mdy(data.rand$Effective.Date))
data.rand$start.year=data.rand$start.year+ceiling(data.rand$start.month/6)-1
data.rand$end.year=data.rand$end.year+ceiling(data.rand$end.month/6)-1
data.rand=clean_names(data.rand)

year=2007
blank.df=NULL
while(year<=2019){
      blank.df=data.rand%>%filter(start_year<=year,end_year>year)%>%count(state,type_of_law,effect)%>%cbind(year)%>%rbind(blank.df)
      year=year+1
}
skel=expand.grid(unique(data.rand$state),unique(data.rand$type_of_law),unique(data.rand$effect),2007:2019)
skel=as.data.frame(skel)
names(skel)<-c("state","type_of_law","effect","year")
skel$state=as.character(skel$state)
rand.count.data=merge(skel,blank.df,by=c("state","type_of_law","effect","year"),all=TRUE)
rand.count.data[is.na(rand.count.data$n),"n"]=0
names(rand.count.data)[5]<-"count"
rand.count.data=unite(rand.count.data,"law_effect",c("type_of_law","effect"),sep="â€”")%>%spread("law_effect","count")

```
